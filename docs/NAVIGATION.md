# ナビゲーション・動線仕様

各画面の「戻る」ボタン・ナビゲーション・スタックの動作を明確に定義します。

> **関連ドキュメント**: 
> - [UI画面仕様](UI-DESIGN.md) - 各画面の詳細UI仕様
> - [アクセシビリティ仕様](ACCESSIBILITY.md) - タップ領域・フォント・コントラスト

---

## ナビゲーション統一ルール

全画面で一貫したナビゲーション体験を提供するため、以下の統一ルールを適用します。

### ルール1: 確認ダイアログの表示条件

**データ損失リスクがある場合のみ確認ダイアログを表示する**

| 条件 | 確認ダイアログ | 理由 |
|------|---------------|------|
| **進行中のゲームセッションを中断する** | ✅ 表示 | スコアが記録されず、プレイ時間が無駄になる |
| **グループ対戦のルームを解散する（ホストのみ）** | ✅ 表示 | 他の参加者に影響を与える |
| **グループ対戦のルームから離脱する（参加者のみ）** | ❌ 非表示 | 個人の離脱は影響が限定的 |
| **結果・ランキング・設定などの閲覧画面から戻る** | ❌ 非表示 | データ損失リスクなし |
| **ゲームフロー完了後の画面から戻る** | ❌ 非表示 | 既に結果が確定している |

**確認ダイアログの標準フォーマット**:
- **タイトル**: 操作名（例: 「プレイを中断しますか？」「ルームを解散しますか？」）
- **メッセージ**: 影響内容（例: 「スコアは記録されません」「他の参加者が退出します」）
- **ボタン**: 
  - キャンセル（グレー・左）: 操作をキャンセルして現在の画面に留まる
  - 確認（ティール・右）: 操作を実行して前画面に戻る

### ルール2: 戻り先の決定規則

**基本原則: 常にナビゲーションスタックの前画面に戻る**

| 画面タイプ | 戻り先 | スタック操作 | 例外 |
|-----------|--------|-------------|------|
| **ゲームフロー内の画面**（安全警告、プレイ、結果） | 前画面 | スタックに積む | ゲームフロー終了時は飲み物選択に戻る（スタッククリア） |
| **閲覧・設定画面**（ランキング、ショップ、プロフィール） | 前画面 | スタックに積む | なし |
| **グループ対戦フロー**（ルーム作成、待機、結果） | 前画面 | スタックに積む | ルーム解散時はルーム作成/参加画面に戻る |

**ゲームフロー終了の定義**:
- 結果画面から「×」で戻る → ゲームフロー完了として、飲み物選択に戻る（スタッククリア）
- プレイ画面から「×」で戻る → ゲームフロー中断として、飲み物選択に戻る（スタッククリア）
- 結果画面から「TRY AGAIN」→ ゲームフロー継続として、プレイ画面に遷移（安全警告スキップ、スタックに積む）

### ルール3: スタック管理の原則

**スタックに積む場合**:
- 通常の画面遷移（飲み物選択 → ランキング、結果 → ランキングなど）
- ゲームフロー内の遷移（安全警告 → プレイ → 結果）
- グループ対戦フロー内の遷移（ルーム作成 → 待機 → プレイ → 結果）

**スタックをクリアする場合**:
- ゲームフロー完了後の「×」ボタン（結果画面 → 飲み物選択）
- ゲームフロー中断時の「×」ボタン（プレイ画面 → 飲み物選択）
- 「CHANGE DRINK」ボタン（結果画面 → 飲み物選択）
- ルーム解散後（待機ルーム → ルーム作成/参加画面）

**スタックの視覚的表現**:
- iOS標準のナビゲーションスタックを使用（SwiftUI `NavigationStack` または UIKit `UINavigationController`）
- 戻るボタンは自動的に前画面のタイトルまたは「戻る」アイコンを表示

---

## 戻るボタンの行き先（統一ルール適用後）

| 画面 | 戻るボタン/×の位置 | 行き先 | 確認ダイアログ | スタック操作 | 備考 |
|------|-------------------|--------|----------------|-------------|------|
| **飲み物選択** | 左上・左矢印 | 設定画面（またはアプリを最小化） | ❌ なし | - | アプリのホーム画面。戻るボタンは設定画面へ遷移、またはアプリをバックグラウンドに |
| **安全警告** | なし（スキップ不可） | - | - | - | ゲームフロー必須画面。戻るボタンは表示しない |
| **プレイ** | 左上・× | 飲み物選択に戻る | ✅ **あり** | スタッククリア | **確認ダイアログ**: 「プレイを中断しますか？スコアは記録されません」→ はい（戻る）/ いいえ（続行） |
| **結果** | 左上・× | 飲み物選択に戻る | ❌ なし | スタッククリア | ゲームフロー完了後の終了操作。スタックをクリアして飲み物選択に戻る |
| **ランキング** | 左上・左矢印 | **直前の画面**（ナビゲーションスタックの前画面） | ❌ なし | スタックに積む | 結果から来た場合は結果、飲み物選択から来た場合は飲み物選択に戻る |
| **ショップ** | 左上・左矢印 | **直前の画面** | ❌ なし | スタックに積む | 通常は飲み物選択から遷移 |
| **プロフィール** | 左上・左矢印 | **直前の画面** | ❌ なし | スタックに積む | 通常は飲み物選択から遷移 |
| **グループ対戦（ルーム作成）** | 左上・左矢印 | 飲み物選択に戻る | ❌ なし | スタックに積む | グループ対戦フローの開始点 |
| **グループ対戦（ルーム参加）** | 左上・左矢印 | 飲み物選択に戻る | ❌ なし | スタックに積む | グループ対戦フローの開始点 |
| **グループ対戦（待機ルーム）** | 左上・× | ルーム作成/参加画面に戻る | ✅ **ホストのみあり** | スタックに積む | **ホストの場合**: 「ルームを解散しますか？他の参加者が退出します」→ はい（解散）/ いいえ（続行）<br>**参加者の場合**: 確認なしで離脱 |
| **グループ結果** | 左上・× | 飲み物選択に戻る | ❌ なし | スタッククリア | グループ対戦フロー完了後の終了操作 |

---

## グループ対戦モードへの入口

- **配置**: 飲み物選択画面のフッターナビゲーションに **5番目のタブ**（複数人アイコン + 「GROUP」ラベル）を追加。
  - フッター: ゲーム（選択中）/ ランキング / ショップ / プロフィール / **グループ**
- **タップ時**: モード選択画面（通常プレイ / グループ対戦）に遷移、またはグループ対戦のトップ（ルーム作成/参加選択）に直接遷移。

---

## ランキング画面へのナビゲーション整理

| 入口元 | ボタン/アイコン | 遷移先 | 注記 |
|--------|----------------|--------|------|
| 飲み物選択 | フッター「ランキング」タブ（グラフアイコン） | ランキング画面（デフォルトは「GLOBAL・今月」） | - |
| プレイ画面 | 右上グラフアイコン | ランキング画面（同上） | プレイ中なので、ランキングを見ても**プレイは継続**（バックグラウンド） |
| 結果画面 | 右上棒グラフアイコン | ランキング画面（デフォルトは「GLOBAL・今月」、または「WEEKLY・今週」にユーザーが切り替え可能） | 結果後なので自分のスコアと比較しやすい |

**アイコンの使い分け**（混乱回避）:
- **グラフアイコン**（棒グラフ横向き）: ランキング用
- **統計アイコン**（折れ線グラフ or チャート）: セッション統計用（将来追加時）

---

## オンボーディング完了後の到達画面

- チュートリアル → 初回プレイ → ニックネーム設定が完了したら、**飲み物選択画面**に到達します。
- 以降、アプリ起動時は常に**飲み物選択がホーム**となります（通常モード）。
- グループ対戦はフッターの「グループ」タブから起動します。

---

## ナビゲーションスタックのルール（統一ルール適用後）

### 通常プレイフロー

**フロー**: `飲み物選択 → 安全警告 → プレイ → 結果`

- **遷移時**: 各画面は**スタックに積む**（`飲み物選択` → `安全警告` → `プレイ` → `結果`）
- **結果画面から「×」で戻る**: **スタックをクリア**して飲み物選択に戻る（ゲームフロー完了）
- **プレイ画面から「×」で戻る**: **スタックをクリア**して飲み物選択に戻る（ゲームフロー中断、確認ダイアログ表示）

### 結果画面からのアクション

| アクション | 遷移先 | スタック操作 | 備考 |
|-----------|--------|-------------|------|
| **「×」ボタン** | 飲み物選択 | スタッククリア | ゲームフロー完了として終了 |
| **「TRY AGAIN」** | プレイ画面（安全警告スキップ） | スタックに積む | ゲームフロー継続。安全警告は2回目以降はスキップ可能（[UI画面仕様](UI-DESIGN.md)の安全警告画面参照） |
| **「CHANGE DRINK」** | 飲み物選択 | スタッククリア | ゲームフロー完了として終了 |
| **右上グラフアイコン** | ランキング画面 | スタックに積む | 結果画面はスタックに残る。ランキングから戻ると結果画面に戻る |

### ランキング画面への遷移

| 入口元 | スタック操作 | 戻り先 |
|--------|-------------|--------|
| **飲み物選択**（フッター「ランキング」タブ） | スタックに積む | 飲み物選択に戻る |
| **結果画面**（右上グラフアイコン） | スタックに積む | 結果画面に戻る |
| **プレイ画面**（右上グラフアイコン） | スタックに積む | プレイ画面に戻る（プレイは継続） |

### グループ対戦フロー

**フロー**: `飲み物選択 → ルーム作成/参加 → 待機ルーム → プレイ → 結果 → グループ結果`

- **遷移時**: 各画面は**スタックに積む**
- **待機ルームから「×」で戻る**: 
  - ホスト: 確認ダイアログ表示 → 解散 → ルーム作成/参加画面に戻る（スタックに積む）
  - 参加者: 確認なし → ルーム作成/参加画面に戻る（スタックに積む）
- **グループ結果から「×」で戻る**: **スタックをクリア**して飲み物選択に戻る（グループ対戦フロー完了）
- **「PLAY AGAIN」**: 同じルームで再プレイ（飲み物選択から開始、スタックに積む）

### スタック管理の実装指針

**SwiftUI の場合**:
```swift
// ゲームフロー完了時（スタッククリア）
navigationPath.removeLast(navigationPath.count) // または navigationPath = NavigationPath()

// 通常の遷移（スタックに積む）
navigationPath.append(NextScreen())
```

**UIKit の場合**:
```swift
// ゲームフロー完了時（スタッククリア）
navigationController?.popToRootViewController(animated: true)

// 通常の遷移（スタックに積む）
navigationController?.pushViewController(nextViewController, animated: true)
```

---

*詳細なUI仕様については [UI-DESIGN.md](UI-DESIGN.md) を参照してください。*
